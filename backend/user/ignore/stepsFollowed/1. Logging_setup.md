## WINSTON Logging & MORGAN Request Tracing Setup

### 1. Install Logging Dependencies

- Install runtime dependencies:

  ```bash
  npm i winston morgan winston-daily-rotate-file
  ```

- Install dev types:

  ```bash
  npm i -D @types/morgan
  ```

---

### 2. Winston Logger Configuration

**File:** `src/utils/logger.js`

```js
import winston from "winston";
import "winston-daily-rotate-file";
import path from "path";

const { combine, timestamp, json, errors } = winston.format;
const LOG_DIR = path.resolve("logs"); // absolute path

// exact-level filters
const errorFilter = winston.format((info) =>
  info.level === "error" ? info : false
)();
const infoFilter = winston.format((info) =>
  info.level === "info" ? info : false
)();

// helper to create rotating transport
const rotate = ({ filename, format }) => {
  return new winston.transports.DailyRotateFile({
    dirname: LOG_DIR,
    filename,
    datePattern: "YYYY-MM-DD",
    maxFiles: "14d",
    format,
  });
};

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  format: combine(errors({ stack: true }), timestamp(), json()),
  defaultMeta: { service: "user-service" },
  transports: [
    // combined log for all levels
    rotate({
      filename: "combined-%DATE%.log",
      format: combine(errors({ stack: true }), timestamp(), json()),
    }),
    // exact error logs
    rotate({
      filename: "app-%DATE%-error.log",
      level: "error",
      format: combine(
        errors({ stack: true }),
        errorFilter,
        timestamp(),
        json()
      ),
    }),
    // exact info logs
    rotate({
      filename: "app-%DATE%-info.log",
      level: "info",
      format: combine(infoFilter, timestamp(), json()),
    }),
    // console output for http logs (used by morgan)
    new winston.transports.Console({
      level: "http",
      format: combine(timestamp(), json()),
    }),
  ],
  exceptionHandlers: [
    rotate({
      filename: "app-%DATE%-exceptions.log",
      format: combine(errors({ stack: true }), timestamp(), json()),
    }),
  ],
  rejectionHandlers: [
    rotate({
      filename: "app-%DATE%-rejections.log",
      format: combine(errors({ stack: true }), timestamp(), json()),
    }),
  ],
});

export default logger;
```

---

### 3. Morgan Middleware (Winston-backed)

**File:** `src/middleware/morganMiddleware.js`

```js
import morgan from "morgan";
import logger from "../utils/logger.js";

const morganMiddleware = morgan(
  function (tokens, req, res) {
    return JSON.stringify({
      method: tokens.method(req, res),
      url: tokens.url(req, res),
      status: Number.parseFloat(tokens.status(req, res)),
      content_length: tokens.res(req, res, "content-length"),
      response_time: Number.parseFloat(tokens["response-time"](req, res)),
    });
  },
  {
    stream: {
      write: (message) => {
        const data = JSON.parse(message);
        logger.http("incoming-request", data);
      },
    },
  }
);

export default morganMiddleware;
```

---

### 4. Express App Integration

**File:** `src/index.ts`

```ts
import logger from "./utils/logger.js";
import morganMiddleware from "./middleware/morganMiddleware.js";
import express from "express";
import dotenv from "dotenv";
import axios from "axios";

dotenv.config();
const app = express();

// GLOBAL MIDDLEWARE
app.use(morganMiddleware);

// ROUTES
app.get("/test/crypto", async (req, res) => {
  try {
    const response = await axios.get(
      "https://api2.binance.com/api/v3/ticker/24hr"
    );
    res.json(response.data);
  } catch (err) {
    logger.error(err);
    res.status(500).send("Internal server error");
  }
});

// SERVER
app.listen(4000, (err) => {
  if (err) {
    console.error("Failed to start server:", err);
    return;
  }
  console.log("Server is running on port 4000");
});
```
